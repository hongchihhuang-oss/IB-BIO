<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IB Bio Master Pro | 穩定精準排版版</title>
    
    <!-- 核心資源載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX 科學渲染 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- html2pdf 匯出功能 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; height: 100vh; transition: background 0.3s, color 0.3s; }
        .app-container { height: 100vh; width: 100%; display: flex; flex-direction: column; position: relative; }
        .main-scroll { flex: 1; overflow-y: auto; padding: 1.25rem; }
        .content-buffer { padding-bottom: 100px; width: 100%; }

        /* 主題色彩設定 */
        .theme-light { --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0; --nav-bg: #ffffff; }
        .theme-dark { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --nav-bg: #1e293b; }
        .theme-midnight { --bg-body: #000000; --bg-card: #111111; --text-main: #ffffff; --text-sub: #a1a1aa; --border: #27272a; --nav-bg: #111111; }

        body.theme-light, body.theme-dark, body.theme-midnight { background: var(--bg-body); color: var(--text-main); }

        .header-fixed { border-bottom: 1px solid var(--border); background: var(--nav-bg); padding: 12px 0; }
        .glass-nav { background: var(--nav-bg); border-top: 1px solid var(--border); height: 75px; flex-shrink: 0; display: flex; justify-content: space-around; align-items: center; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-weight: 800; font-size: 0.7rem; cursor: pointer; transition: 0.2s; gap: 4px; }
        .nav-active { color: #3b82f6; }
        
        /* 網頁版卡片 */
        .themed-card { border-left-width: 6px; padding: 1.5rem; border-radius: 1.5rem; background: var(--bg-card); margin-bottom: 1.1rem; border: 1px solid var(--border); border-left-width: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-blue { border-left-color: #3b82f6; }
        .card-rose { border-left-color: #e11d48; }
        .card-amber { border-left-color: #f59e0b; }
        .card-emerald { border-left-color: #10b981; }
        .card-slate { border-left-color: #64748b; }

        .badge-mini { font-size: 0.65rem; font-weight: 900; padding: 3px 10px; border-radius: 6px; margin-bottom: 8px; display: inline-block; text-transform: uppercase; background: var(--bg-body); color: var(--text-sub); border: 1px solid var(--border); }
        
        .math-container { line-height: 1.8; word-break: break-word; margin-bottom: 0.75rem; }
        .indent-content { padding-left: 1.25rem; border-left: 3px solid var(--border); margin-top: 0.75rem; color: var(--text-sub); }

        .animate-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .option-label { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; background: var(--bg-body); border: 2.5px solid var(--border); flex-shrink: 0; }
        .selected-label { background: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }

        .font-cycle-btn { background: var(--bg-card); padding: 8px 16px; border-radius: 12px; font-weight: 900; font-size: 16px; color: #3b82f6; border: 2px solid var(--border); transition: 0.2s; }
        .back-nav-btn { color: #3b82f6; padding: 10px; border-radius: 14px; background: var(--bg-card); border: 2px solid var(--border); }
        .next-nav-btn { color: #3b82f6; padding: 10px; border-radius: 12px; background: var(--bg-card); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .mastery-toggle-btn { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: 0.2s; background: var(--bg-card); border: 2px solid var(--border); }

        /* --- PDF 專業列印優化 (回歸理想精簡版) --- */
        .print-only { display: none; }
        .pdf-mode .print-only { display: block !important; margin-bottom: 20px; }
        
        /* 移除過度留白與背景，維持白底黑字 */
        .pdf-mode { background: #ffffff !important; color: #000000 !important; padding: 10mm !important; width: 100% !important; height: auto !important; overflow: visible !important; }
        
        /* 移除浪費墨水的框框，改用純文字段落 */
        .pdf-mode .themed-card { 
            background: #ffffff !important; 
            color: #000000 !important; 
            border: none !important; 
            border-left: none !important;
            box-shadow: none !important; 
            margin-bottom: 1rem !important; 
            padding: 0 !important;
            border-radius: 0 !important;
            break-inside: avoid; /* 核心：防止文字切斷 */
            page-break-inside: avoid;
        }
        
        .pdf-mode .badge-mini { 
            background: none !important; 
            color: #000000 !important; 
            border: none !important; 
            font-size: 11pt !important; 
            font-weight: 900 !important; 
            margin-bottom: 4px !important;
            padding: 0 !important;
            text-decoration: underline; /* 以底線標示區塊 */
        }

        .pdf-mode .math-container { color: #000000 !important; font-size: 11pt !important; line-height: 1.6 !important; }
        .pdf-mode .indent-content { 
            color: #000000 !important; 
            border-left: none !important; 
            padding-left: 0 !important;
            margin-top: 5px !important;
        }
        
        .pdf-mode .header-fixed, .pdf-mode .glass-nav, .pdf-mode button { display: none !important; }
    </style>
</head>
<body class="theme-dark">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useLayoutEffect, Fragment, useCallback, useRef, useMemo } = React;

        const THEMES = [
            { id: "A", name: "Unity & Molecules", color: "#3b82f6" }, 
            { id: "B", name: "Function & Cells", color: "#10b981" }, 
            { id: "C", name: "Interaction", color: "#8b5cf6" }, 
            { id: "D", name: "Evolution", color: "#f59e0b" }
        ];

        // --- 元件圖示 ---
        const AppIcon = ({ name, size = 18, color = "currentColor", fill = "none", strokeWidth = "2.5" }) => {
            const icons = {
                Home: <svg width={size} height={size} fill={fill} stroke={color} viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" strokeLinecap="round" strokeLinejoin="round" strokeWidth={strokeWidth}/></svg>,
                Brain: <svg width={size} height={size} fill={fill} stroke={color} viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={strokeWidth}/></svg>,
                Config: <svg width={size} height={size} fill={fill} stroke={color} viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={strokeWidth}/><circle cx="12" cy="12" r="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={strokeWidth}/></svg>,
                Check: <svg width={size} height={size} fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth={strokeWidth} viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12" /></svg>,
                House: <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="3.5" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
                Star: <svg width={size} height={size} fill={fill} stroke={color} strokeWidth="2.5" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>,
                NextArrow: <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="4.5" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>,
                Download: <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
                Sparkles: <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path d="M5 3l.94 2.06L8 6l-2.06.94L5 9l-.94-2.06L2 6l2.06-.94L5 3zm14 15l.94 2.06L22 21l-2.06.94L19 24l-.94-2.06L16 21l2.06-.94L19 18zm4.5-10.5l1.09 2.41L27 11l-2.41 1.09L23.5 14.5l-1.09-2.41L20 11l2.41-1.09L23.5 7.5z"/></svg>
            };
            return icons[name] || null;
        };

        const bioCompiler = (raw) => {
            let text = String(raw || "").trim();
            if (!text) return "";
            text = text.replace(/LATEX_PROTECT_\d+/g, "").replace(/LATEX_RESTORE_\d+/g, "").replace(/LATEX_SHIELD_\d+/g, "").replace(/\\text\{([^}]+)\}/g, "$1").replace(/(\*\*|__)/g, "").replace(/#+\s?/g, "").replace(/Supplement for:.*?\n/gi, "").replace(/---/g, "");
            const lines = text.split('\n');
            let finalHTML = [];
            let inTable = false;
            let tableData = [];
            lines.forEach((l) => {
                const line = l.trim();
                if (!line) return;
                if (line.includes('|')) {
                    const cells = line.split('|').filter(c => c.trim().length > 0).map(c => c.trim());
                    if (cells.length > 0 && !line.includes(':---')) {
                        if (!inTable) { inTable = true; tableData = []; }
                        tableData.push(cells);
                    }
                } else {
                    if (inTable && tableData.length > 0) {
                        finalHTML.push(`<table class="bio-table"><thead><tr>${tableData[0].map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>${tableData.slice(1).map(row => `<tr>${row.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`);
                        inTable = false; tableData = [];
                    }
                    finalHTML.push(`<div class="mb-3 math-container">${line}</div>`);
                }
            });
            return finalHTML.join('');
        };

        const App = () => {
            // --- 狀態管理 ---
            const [themeMode, setThemeMode] = useState(localStorage.getItem('theme_mode') || 'theme-dark');
            const [contentFontSize, setContentFontSize] = useState(Number(localStorage.getItem('contentFontSize')) || 16);
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [statusMsg, setStatusMsg] = useState("");
            const [aiProgress, setAiProgress] = useState(""); 
            const [generatedJson, setGeneratedJson] = useState(""); 
            const [tab, setTab] = useState('home');
            const [masterBank, setMasterBank] = useState({ A:[], B:[], C:[], D:[] });
            const [masteredIds, setMasteredIds] = useState(new Set(JSON.parse(localStorage.getItem('mastered_ids') || '[]')));
            const [quizStep, setQuizStep] = useState('setup'); 
            const [queue, setQueue] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [sessionResults, setSessionResults] = useState({});
            const [tempAnswer, setTempAnswer] = useState('');
            const [loading, setLoading] = useState(false);
            const [selThemes, setSelThemes] = useState(['A']); 
            const [selType, setSelType] = useState('MCQ');
            const [buildTheme, setBuildTheme] = useState('A');

            const cur = useMemo(() => (queue && queue.length > 0) ? queue[currentIndex] : null, [queue, currentIndex]);

            // --- 物理渲染監控 ---
            useLayoutEffect(() => {
                document.body.className = themeMode;
                const triggerKaTeX = () => { if (window.renderMathInElement) renderMathInElement(document.body, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}], throwOnError: false }); };
                triggerKaTeX();
                const observer = new MutationObserver(() => triggerKaTeX());
                observer.observe(document.body, { childList: true, subtree: true, characterData: true });
                const timers = [setTimeout(triggerKaTeX, 50), setTimeout(triggerKaTeX, 150), setTimeout(triggerKaTeX, 400)];
                return () => { observer.disconnect(); timers.forEach(clearTimeout); };
            }, [quizStep, currentIndex, sessionResults, tab, contentFontSize, themeMode, cur]);

            useEffect(() => {
                const loadData = async () => {
                    const pool = { A:[], B:[], C:[], D:[] };
                    const targets = ['questions_bank.json', 'questions_bank_A.json', 'questions_bank_B.json', 'questions_bank_C.json', 'questions_bank_D.json'];
                    for (const f of targets) {
                        try {
                            const res = await fetch(`./${f}`);
                            if (res.ok) {
                                const data = await res.json();
                                Object.keys(data).forEach(k => {
                                    const u = k.toUpperCase().replace('THEME ', '').trim();
                                    if (pool[u]) pool[u] = [...pool[u], ...(data[k] || [])];
                                });
                            }
                        } catch (e) {}
                    }
                    const local = JSON.parse(localStorage.getItem('local_custom_bank') || '{}');
                    Object.keys(local).forEach(u => {
                        const id = u.toUpperCase().replace('THEME ', '').trim();
                        if (pool[id]) pool[id] = [...pool[id], ...(local[u] || [])];
                    });
                    setMasterBank(pool);
                };
                loadData();
            }, []);

            const stats = useMemo(() => {
                const map = new Map();
                Object.values(masterBank).flat().forEach(q => { if (q && q.id) map.set(q.id, q); });
                const all = Array.from(map.values());
                const count = (tid) => all.filter(q => q.theme === tid || String(q.id).startsWith(tid)).length;
                return { total: all.length, mastered: masteredIds.size, A: count('A'), B: count('B'), C: count('C'), D: count('D') };
            }, [masterBank, masteredIds]);

            const exportPDF = useCallback(() => {
                const el = document.getElementById('report-content');
                if (!el) return;
                el.classList.add('pdf-mode');
                const opt = { 
                    margin: [10, 10, 10, 10], 
                    filename: 'Assessment_Report.pdf', 
                    image:{type:'jpeg',quality:1}, 
                    html2canvas:{scale:2, useCORS: true}, 
                    jsPDF:{unit:'mm',format:'a4', orientation: 'portrait'} 
                };
                html2pdf().set(opt).from(el).save().then(() => el.classList.remove('pdf-mode'));
            }, []);

            // --- 精準切割引擎 (優化論述題範文風格與切割品質) ---
            const renderFeedback = useCallback((text, isErq, expl, prefetched) => {
                const cards = [];
                const sourceText = String(text || "").trim();
                const bankInsight = String(prefetched || "").trim();

                // 1. 選擇題正確詳解 (綠色)
                if (!isErq && expl) {
                    cards.push(
                        <div key="expl" className="themed-card card-emerald">
                            <span className="badge-mini border-none">Correct Answer Detail: {cur?.answer}</span>
                            <div className="font-semibold" dangerouslySetInnerHTML={{ __html: bioCompiler(expl) }} />
                        </div>
                    );
                }

                // 2. 切割標籤定義 (論述與選擇徹底分離)
                const erqMarkers = ["Mark Scheme Analysis", "Knowledge Gaps", "Pathway to Level 7"];
                const mcqMarkers = ["Key Concept", "Pitfall", "Fact", "Deep Analysis"];
                
                const activeMarkers = isErq ? erqMarkers : mcqMarkers;

                let segs = [];
                activeMarkers.forEach(m => {
                    const idx = sourceText.indexOf(m);
                    if (idx !== -1) segs.push({ name: m, start: idx, len: m.length });
                });
                segs.sort((a,b) => a.start - b.start);

                segs.forEach((s, i) => {
                    const nextStart = (i + 1 < segs.length) ? segs[i+1].start : sourceText.length;
                    const content = sourceText.substring(s.start + s.len, nextStart).replace(/^[:\s\*-]+/, "").trim();
                    if (content.length > 5) {
                        let color = "card-blue", label = s.name;
                        if (isErq) {
                            if (s.name.includes("Mark")) color = "card-emerald";
                            else if (s.name.includes("Gap")) color = "card-rose";
                            else if (s.name.includes("Level")) color = "card-amber";
                        }
                        cards.push(
                            <div key={s.name+i} className={`themed-card ${color}`}>
                                <span className="badge-mini border-none">{label}</span>
                                <div className="font-medium opacity-80 indent-content" dangerouslySetInnerHTML={{ __html: bioCompiler(content) }} />
                            </div>
                        );
                    }
                });

                // 3. 還原：Model Exemplar (標竿範文) - 改回考生作答風格
                if (isErq && bankInsight.length > 10) {
                    cards.push(
                        <div key="bank-ref" className="themed-card card-slate">
                            <span className="badge-mini border-none">Model Exemplar (Student Sample)</span>
                            <div className="font-medium opacity-80 italic leading-relaxed text-blue-500/80" dangerouslySetInnerHTML={{ __html: bioCompiler(bankInsight) }} />
                        </div>
                    );
                }
                
                // 4. 庫存科學知識 (選擇題專用)
                if (!isErq && bankInsight.length > 10) {
                    let bankSegs = [];
                    mcqMarkers.forEach(m => {
                        const idx = bankInsight.indexOf(m);
                        if (idx !== -1) bankSegs.push({ name: m, start: idx, len: m.length });
                    });
                    bankSegs.sort((a,b) => a.start - b.start);
                    bankSegs.forEach((s, i) => {
                        const nextStart = (i + 1 < bankSegs.length) ? bankSegs[i+1].start : bankInsight.length;
                        const content = bankInsight.substring(s.start + s.len, nextStart).replace(/^[:\s\*-]+/, "").trim();
                        if (content.length > 5) {
                            cards.push(
                                <div key={"bank"+s.name+i} className="themed-card card-blue">
                                    <span className="badge-mini border-none">{s.name}</span>
                                    <div className="font-medium opacity-80 indent-content" dangerouslySetInnerHTML={{ __html: bioCompiler(content) }} />
                                </div>
                            );
                        }
                    });
                }

                if (cards.length === 0 && sourceText.length > 10) {
                    cards.push(<div key="raw" className="themed-card card-blue"><span className="badge-mini border-none">Evaluation</span><div dangerouslySetInnerHTML={{ __html: bioCompiler(sourceText) }} /></div>);
                }
                return cards;
            }, [cur]);

            const startPractice = () => {
                const pool = selThemes.flatMap(t => masterBank[t] || []).filter(q => q && q.id && q.type === selType && !masteredIds.has(q.id));
                const uniquePool = Array.from(new Map(pool.map(q => [q.id, q])).values());
                if (uniquePool.length) {
                    setQueue([...uniquePool].sort(() => Math.random() - 0.5));
                    setCurrentIndex(0); setQuizStep('practice'); setSessionResults({}); setTempAnswer('');
                } else showToast("目前無可用題目");
            };

            const handleNext = () => {
                if (!queue || queue.length === 0) return;
                if (currentIndex + 1 >= queue.length) { showToast("練習完成！"); setQuizStep('setup'); return; }
                const curId = cur?.id;
                if (masteredIds.has(curId)) { setQueue(queue.filter(q => q.id !== curId)); } else { setCurrentIndex(prev => prev + 1); }
                setTempAnswer('');
            };

            const submitMcq = (k, ans) => { if (cur) setSessionResults(prev => ({ ...prev, [cur.id]: { answer: k, isCorrect: String(k).toUpperCase() === String(ans).toUpperCase() } })); };

            const submitErq = async () => {
                if (!tempAnswer.trim() || loading) return;
                setLoading(true);
                const fb = await askAI(`Evaluate: "${cur.question}" with Student Answer: "${tempAnswer}". MUST use EXACT headers: Mark Scheme Analysis, Knowledge Gaps, Pathway to Level 7.`, "Senior IB Bio Moderator.");
                if (fb) setSessionResults(prev => ({ ...prev, [cur.id]: { answer: tempAnswer, feedback: fb } }));
                setLoading(false);
            };

            const askAI = async (p, s, retries = 5, delay = 1000) => {
                if (!userApiKey) return null;
                setAiProgress("準備連線...");
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: p }] }], systemInstruction: { parts: [{ text: s }] } })
                    });
                    if (res.status === 429 && retries > 0) { setAiProgress(`限額重試 (${delay/1000}s)...`); await new Promise(r => setTimeout(r, delay)); return askAI(p, s, retries - 1, delay * 2); }
                    if (!res.ok) throw new Error();
                    setAiProgress("AI 思考中...");
                    const data = await res.json();
                    setAiProgress("解析數據...");
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { setAiProgress(""); return null; }
            };

            const showToast = (msg) => { setStatusMsg(msg); setTimeout(() => setStatusMsg(""), 3000); };

            return (
                <div className="app-container">
                    {statusMsg && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-blue-600 text-white px-6 py-3 rounded-2xl shadow-2xl font-black text-xs uppercase tracking-widest">{statusMsg}</div>}
                    <header className="header-fixed flex items-center justify-between px-4 py-3">
                        <div className="flex items-center gap-2">
                            {tab === 'quiz' && quizStep === 'practice' && <button onClick={() => setQuizStep('setup')} className="back-nav-btn shadow-sm active:scale-95"><AppIcon name="House" size={24} /></button>}
                            {tab === 'quiz' && quizStep === 'practice' && <div className="ml-2 bg-slate-800/10 px-2.5 py-1.5 rounded-xl border border-slate-700/20"><span className="text-[11px] font-black uppercase">Q {currentIndex + 1} / {queue.length}</span></div>}
                        </div>
                        <h1 className="font-black italic text-sm uppercase tracking-widest text-blue-500 opacity-80">IB Bio Master Pro</h1>
                        <div className="flex items-center gap-2">
                            {tab === 'quiz' && quizStep === 'practice' && cur && (
                                <button onClick={() => { setMasteredIds(prev => { const next = new Set(prev); if (next.has(cur.id)) next.delete(cur.id); else next.add(cur.id); localStorage.setItem('mastered_ids', JSON.stringify(Array.from(next))); return next; }); }} className={`mastery-toggle-btn shadow-sm active:scale-95 ${masteredIds.has(cur.id) ? 'bg-amber-500 text-white border-amber-500' : ''}`}><AppIcon name="Star" size={20} fill={masteredIds.has(cur.id) ? "white" : "none"} /></button>
                            )}
                            {tab === 'quiz' && quizStep === 'practice' && <button onClick={() => { const sizes = [14, 16, 19, 23]; setContentFontSize(prev => sizes[(sizes.indexOf(prev) + 1) % sizes.length]); }} className="font-cycle-btn shadow-sm">Aa</button>}
                            {tab === 'quiz' && quizStep === 'practice' && <button onClick={handleNext} className="next-nav-btn shadow-sm active:scale-95"><AppIcon name="NextArrow" size={22} /></button>}
                        </div>
                    </header>

                    <main className="main-scroll">
                        <div className="content-buffer">
                            {tab === 'home' && (
                                <div className="space-y-4 animate-up">
                                    <div className="themed-card card-slate text-center border-none py-8 shadow-none">
                                        <div className="grid grid-cols-2 gap-3 mb-6"><div className="p-3 rounded-2xl border border-slate-700/20 bg-slate-800/20"><p className="text-xl font-black text-blue-400">{stats.total}</p><p className="text-[9px] opacity-40 uppercase font-black tracking-widest">Stock</p></div><div className="p-3 rounded-2xl border border-slate-700/20 bg-slate-800/20"><p className="text-xl font-black text-emerald-400">{stats.mastered}</p><p className="text-[9px] opacity-40 uppercase font-black tracking-widest">Mastered</p></div></div>
                                        <div className="grid grid-cols-4 gap-2">{THEMES.map(t => (<div key={t.id} className="text-center"><p className="text-[10px] font-black uppercase" style={{ color: t.color }}>{t.id}</p><p className="text-sm font-black">{stats[t.id]}</p></div>))}</div>
                                    </div>
                                    <div className="themed-card border-none space-y-4">
                                        <h2 className="font-black text-xs uppercase italic opacity-40 flex items-center gap-2"><AppIcon name="Sparkles" size={12} /> AI Generator</h2>
                                        <div className="space-y-3">
                                            <div className="flex gap-2 p-1 rounded-xl bg-slate-800/20">{THEMES.map(t=>(<button key={t.id} onClick={()=>setBuildTheme(t.id)} className={`flex-1 py-1.5 rounded-lg font-black text-xs transition-all ${buildTheme===t.id ? 'bg-slate-700 text-white shadow-md' : 'opacity-40'}`} style={{ color: buildTheme===t.id ? t.color : 'inherit' }}>{t.id}</button>))}</div>
                                            <button onClick={async()=>{setLoading(true); setAiProgress("準備中..."); const usr=`Generate 10 IB bio questions for Unit ${buildTheme}. JSON object { "${buildTheme}": [ ... ] }. Include prefetchedInsight with student-style model answers. Use plain text like Rubisco.`; const r = await askAI(usr, "Expert IB Bio Teacher. JSON only."); if(r) { const m = r.match(/\{[\s\S]*\}/); if(m) importToBank(JSON.parse(m[0])); } setLoading(false); setAiProgress("");}} disabled={loading} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] shadow-md hover:bg-blue-500 disabled:opacity-50">{loading ? (aiProgress || '運作中...') : 'Generate 10 New Questions'}</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'quiz' && (
                                <div className="space-y-4">
                                    {quizStep === 'setup' ? (
                                        <div className="space-y-4 animate-up">
                                            <div className="flex gap-2">{['MCQ','ERQ'].map(type=>(<button key={type} onClick={()=>setSelType(type)} className={`flex-1 py-3 rounded-lg font-black border-2 transition-all ${selType===type?'bg-slate-100 text-slate-900 border-slate-100 shadow-md':'text-slate-500 bg-slate-800 border-slate-700'}`}>{type}</button>))}</div>
                                            <div className="grid grid-cols-2 gap-2">{THEMES.map(t => (<button key={t.id} onClick={()=>setSelThemes(p=>p.includes(t.id)?(p.length > 1 ? p.filter(i=>i!==t.id) : p):[...p,t.id])} className={`p-4 rounded-xl text-left border-2 transition-all ${selThemes.includes(t.id)?'bg-slate-800/40 shadow-sm':'border-slate-800 opacity-40'}`} style={{ borderColor: selThemes.includes(t.id) ? t.color : '#1f2937' }}><span className="font-black text-xs uppercase" style={{ color: selThemes.includes(t.id) ? t.color : '#475569' }}>Unit {t.id}</span></button>))}</div>
                                            <button onClick={startPractice} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase italic tracking-widest shadow-lg active:scale-95">Start Session</button>
                                        </div>
                                    ) : cur ? (
                                        <div className="space-y-4 animate-up" key={currentIndex}>
                                            <div style={{ fontSize: `${contentFontSize}px` }}>
                                                <div className="themed-card border-none shadow-md">
                                                    <div className="font-black italic border-l-4 border-blue-600 pl-3 mb-6 leading-tight" dangerouslySetInnerHTML={{ __html: bioCompiler(cur.question) }} />
                                                    {cur.type === 'MCQ' ? (
                                                        <div className="grid gap-2">{Object.entries(cur.options || {}).map(([k, v]) => {
                                                            const res = sessionResults[cur.id];
                                                            let st = "border-slate-700/20";
                                                            if (res) { if (String(k)===String(cur.answer)) st="border-emerald-500 bg-emerald-500/10 border-2"; else if (String(k)===String(res.answer)) st="border-rose-500 bg-rose-500/10 border-2"; else st="opacity-30 grayscale"; }
                                                            return (<button key={k} disabled={!!res} onClick={()=>submitMcq(k, cur.answer)} className={`w-full p-3 rounded-xl border text-left transition-all flex items-center gap-3 ${st}`}><span className={`option-label ${res?.answer === k ? 'selected-label shadow-inner' : ''}`}>{k}</span><span className="font-bold opacity-80" dangerouslySetInnerHTML={{ __html: bioCompiler(v) }} /></button>);
                                                        })}</div>
                                                    ) : (
                                                        <div className="space-y-3"><textarea disabled={!!sessionResults[cur.id]} className="w-full p-4 bg-slate-500/5 border-2 border-slate-700/20 rounded-2xl min-h-[160px] outline-none font-medium text-inherit focus:border-blue-500 transition-colors" placeholder="Input analytical response..." value={tempAnswer} onChange={(e)=>setTempAnswer(e.target.value)} />{!sessionResults[cur.id] && <button onClick={submitErq} disabled={!tempAnswer.trim()||loading} className="w-full bg-slate-100 text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest shadow-md active:scale-95 disabled:opacity-50">{loading ? '運作中...' : 'Submit'}</button>}</div>
                                                    )}
                                                </div>
                                                {sessionResults[cur.id] && (
                                                    <div id="report-content" className="mt-8"> {/* 增加首段與報告間距 */}
                                                        <div className="print-only">
                                                            <div style={{ borderBottom: '2px solid black', paddingBottom: '10px', marginBottom: '20px' }}>
                                                                <h1 style={{ fontSize: '18pt', fontWeight: 900, textAlign: 'center' }}>IB BIOLOGY ASSESSMENT REPORT</h1>
                                                            </div>
                                                            <div style={{ marginBottom: '15px' }}>
                                                                <span style={{ fontSize: '11pt', fontWeight: 900, textDecoration: 'underline' }}>EXAM QUESTION:</span>
                                                                <div style={{ marginTop: '5px', fontStyle: 'italic', fontSize: '11pt' }} dangerouslySetInnerHTML={{ __html: bioCompiler(cur.question) }} />
                                                            </div>
                                                            {cur.type === 'ERQ' && (
                                                                <div style={{ marginBottom: '30px' }}>
                                                                    <span style={{ fontSize: '11pt', fontWeight: 900, textDecoration: 'underline' }}>YOUR RESPONSE:</span>
                                                                    <div style={{ marginTop: '5px', fontSize: '11pt', padding: '10px', background: '#f8fafc', borderLeft: '3px solid #ccc' }} dangerouslySetInnerHTML={{ __html: bioCompiler(sessionResults[cur.id].answer) }} />
                                                                </div>
                                                            )}
                                                        </div>

                                                        <div className="p-0 md:p-5 rounded-3xl bg-transparent md:bg-slate-500/5 shadow-none no-animation">
                                                            <div className="flex justify-between items-center mb-5 md:px-0 px-2">
                                                                <span className="text-[10px] font-black opacity-40 uppercase italic tracking-widest">Feedback Analysis</span>
                                                                {cur.type === 'ERQ' && <button onClick={exportPDF} className="text-[11px] font-black text-blue-400 flex items-center gap-1 uppercase hover:underline"><AppIcon name="Download" size={16} /> Get PDF</button>}
                                                            </div>
                                                            {renderFeedback(sessionResults[cur.id].feedback, cur.type === 'ERQ', cur.explanation, cur.prefetchedInsight)}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : (<div className="p-20 text-center animate-pulse opacity-20 font-black italic tracking-widest">SYNCING QUEUE...</div>)}
                                </div>
                            )}

                            {tab === 'config' && (
                                <div className="space-y-4 animate-up">
                                    <div className="themed-card border-none space-y-6 shadow-none">
                                        <div className="space-y-2">
                                            <p className="text-[10px] font-black uppercase opacity-40 italic tracking-widest">Appearance</p>
                                            <div className="grid grid-cols-3 gap-2">
                                                {[ {id:'theme-light', n:'Light'}, {id:'theme-dark', n:'Dark'}, {id:'theme-midnight', n:'Night'} ].map(t=>(
                                                    <button key={t.id} onClick={()=>{setThemeMode(t.id); localStorage.setItem('theme_mode', t.id);}} className={`py-3 rounded-xl font-black text-[10px] border-2 transition-all ${themeMode===t.id ? 'border-blue-500 bg-blue-500/10 text-blue-500' : 'border-slate-700/20 text-slate-500'}`}>{t.n}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="p-4 bg-slate-500/5 border border-slate-700/20 rounded-2xl space-y-2"><p className="text-[9px] font-black uppercase text-blue-400">Gemini Key</p><input type="password" placeholder="API Key" className="w-full p-3 bg-transparent border-none rounded-lg text-sm text-inherit" value={userApiKey} onChange={(e)=>{setUserApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value);}} /></div>
                                        <button onClick={()=>{if(confirm("確定重置所有數據？")){localStorage.clear(); window.location.reload();}}} className="w-full py-3 text-[10px] font-black text-rose-500 bg-rose-50 rounded-lg uppercase tracking-widest border border-rose-500/20 active:scale-95">Reset Data</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    <nav className="glass-nav">
                        <button onClick={()=>setTab('home')} className={`nav-item ${tab==='home'?'nav-active':''}`}><AppIcon name="Home" size={24} />Home</button>
                        <button onClick={()=>setTab('quiz')} className={`nav-item ${tab==='quiz'?'nav-active':''}`}><AppIcon name="Brain" size={24} />Training</button>
                        <button onClick={()=>setTab('config')} className={`nav-item ${tab==='config'?'nav-active':''}`}><AppIcon name="Config" size={24} />Setup</button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
